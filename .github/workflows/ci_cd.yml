name: CI/CD

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install dependencies
      run: |
        until ( npm i -f ); do
          echo "Retrying dependencies installation..."
        done

    - name: Install Cypress
      run: npm install --save-dev cypress -f

    - name: Start server and run Cypress tests
      run: |
        echo "Starting application server..."
        npm run dev & # Run the server in the background
        SERVER_PID=$! # Capture the process ID of the server
        echo "Waiting for server to be ready..."
        echo "Running Cypress tests..."
        npx cypress run || (kill $SERVER_PID && exit 1) # Run Cypress tests
        kill $SERVER_PID # Stop the server after tests
      env:
        NODE_ENV: production

# name: CI/CD

# on:
#   push:
#     branches:
#       - dev
#   pull_request:
#     branches:
#       - dev

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     strategy:
#       matrix:
#         node-version: [20.x]

#     steps:
#     - name: Checkout repository
#       uses: actions/checkout@v2

#     - name: Set up Node.js ${{ matrix.node-version }}
#       uses: actions/setup-node@v1
#       with:
#         node-version: ${{ matrix.node-version }}

#     - name: Install dependencies
#       run: |
#         until ( npm i -f ); do
#           echo "Retrying dependencies installation..."
#         done

#     - name: Install Cypress and start-server-and-test
#       run: |
#         npm install cypress --save-dev start-server-and-test -f

#     - name: Run Cypress tests with server
#       run: npx start-server-and-test 'npm run dev' http://127.0.0.1:5173 cypress:run
#       env:
#         NODE_ENV: production
# ///////////////////////////////////////////////////////////////////////////////////////////////////////////
# name: CI/CD

# on:
#   push:
#     branches:
#       - dev
#   pull_request:
#     branches:
#       - dev

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     strategy:
#       matrix:
#         node-version: [20.x]

#     steps:
#     - name: Checkout repository
#       uses: actions/checkout@v2

#     - name: Set up Node.js ${{ matrix.node-version }}
#       uses: actions/setup-node@v1
#       with:
#         node-version: ${{ matrix.node-version }}

#     - name: Install dependencies
#       run: |
#         until ( npm i -f ); do
#           echo "Retrying dependencies and Cypress installation..."
#         done

#     - name: Install Cypress
#       run: |
#         until ( npm install cypress --save-dev -f ); do
#           echo "Retrying Cypress installation..."
#         done

#     - name: Start the application server
#       run: npm run dev &
#       env:
#         NODE_ENV: production

#     - name: Wait for server to start
#       run: |
#         echo "Waiting for server to start..."
#         for i in {1..20}; do
#           curl -s http://127.0.0.1:5173 > /dev/null && break
#           echo "Server not ready yet. Retrying in 3 seconds..."
#           sleep 3
#         done

#     - name: Run Cypress tests
#       run: npx cypress run

#   test:  
#     needs: build  # Ensures this job waits for the build job to finish
#     runs-on: ubuntu-latest

#     strategy:
#       matrix:
#         node-version: [20.x]

#     steps:
#     - name: Checkout repository
#       uses: actions/checkout@v2

#     - name: Set up Node.js ${{ matrix.node-version }}
#       uses: actions/setup-node@v1
#       with:
#         node-version: ${{ matrix.node-version }}

#     - name: Install cypress
#       run: |
#         until ( npm install cypress --save-dev -f); do
#           echo "Retrying dependencies and Cypress installation..."
#         done
#     - name: Run Cypress tests
#       run: npx cypress run

# name: CI/CD  

# on:  
#   push:  
#     branches:  
#       - dev  # Replace 'main' with your primary branch name  
#   pull_request:  
#     branches:  
#       - dev  # Replace 'main' with your primary branch name  

# jobs:  
#   build-and-test:  
#     runs-on: ubuntu-latest

#     strategy:
#       matrix:
#         node-version: [20.x]

#     steps:
#     - name: Checkout repository
#       uses: actions/checkout@v2

#     - name: Set up Node.js ${{ matrix.node-version }}
#       uses: actions/setup-node@v1
#       with:
#         node-version: ${{ matrix.node-version }}

#     - name: Install dependencies
#       run: |
#         until npm i -f; do
#           echo "Retrying npm install..."
#         done
      
#     - name: Build
#       run: npm run dev
      
#     - name: Run the tests
#       run: npx cypress run
