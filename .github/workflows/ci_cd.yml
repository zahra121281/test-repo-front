jobs:  
  build:  
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}
        
    - name: Install dependencies
      run: |
        until ( npm i -f ); do
          echo "Retrying dependencies and Cypress installation..."
        done
        
    - name: Build the project
      run: npm run build

    - name: Start the application server
      run: nohup npm run dev &> server.log &
      env:
        NODE_ENV: production

    - name: Wait for server to start and check if port 5173 is listening
      run: |
        echo "Waiting for server to start..."
        sleep 30 # Increase this based on your app's startup time
        echo "Checking if port 5173 is listening..."
        ss -tuln | grep ":5173" || echo "Port 5173 is not listening" # Check if port 5173 is open and listening
        cat server.log  # Optional: Print server logs to debug
  test:  
    needs: build  # Ensures this job waits for the build job to finish
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install Cypress
      run: |
        until ( npm install cypress --save-dev -f); do
          echo "Retrying dependencies and Cypress installation..."
        done

    - name: Run Cypress tests
      run: npx cypress run

# name: CI/CD  

# on:  
#   push:  
#     branches:  
#       - dev  # Replace 'main' with your primary branch name  
#   pull_request:  
#     branches:  
#       - dev  # Replace 'main' with your primary branch name  

# jobs:  
#   build-and-test:  
#     runs-on: ubuntu-latest

#     strategy:
#       matrix:
#         node-version: [20.x]

#     steps:
#     - name: Checkout repository
#       uses: actions/checkout@v2

#     - name: Set up Node.js ${{ matrix.node-version }}
#       uses: actions/setup-node@v1
#       with:
#         node-version: ${{ matrix.node-version }}

#     - name: Install dependencies
#       run: |
#         until npm i -f; do
#           echo "Retrying npm install..."
#         done
      
#     - name: Build
#       run: npm run dev
      
#     - name: Run the tests
#       run: npx cypress run
